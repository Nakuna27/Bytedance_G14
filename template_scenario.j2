import requests
import json
import pytest
import time
import random
from faker import Faker
fake = Faker("zh_CN")

{% for scenario in scenarios %}
def {{ scenario.scenario_name }}():
    """ {{ scenario.description }} """
    print(f"\nğŸš€ æ‰§è¡Œ: {{ scenario.description }}")
    vars_pool = {}
    no_proxy = {"http": None, "https": None}

    {% for step in scenario.steps %}
    print(f"  ğŸ‘‰ Step: {{ step.method }} - {{ step.url }}")
    random_text = f"{fake.word()}_{int(time.time())}"

    url = "{{ step.url }}"
    headers = {{ step.headers }}
    body = {{ step.body }}
    params = {{ step.params }}

    def smart_inject(d):
        if isinstance(d, dict):
            for k, v in d.items():
                if isinstance(v, dict): smart_inject(v)
                elif isinstance(v, list):
                    for item in v: smart_inject(item)
                elif isinstance(v, str) and "raw_data" in v:
                    if k in ["title", "name"]: d[k] = f"Auto_{fake.word()}"[:10]
                    elif k == "content":
                        try: d[k] = json.dumps({"text": f"ğŸ¤– {random_text}"})
                        except: pass
                    else: d[k] = f"ğŸ¤– {random_text}"
        return d
    body = smart_inject(body)

    for k, v in vars_pool.items():
        if f"${k}" in url:
            url = url.replace(f"${k}", str(v))
            print(f"     ğŸ”„ æ›¿æ¢URL: ${k} -> {v}")

    try:
        response = requests.request("{{ step.method }}", url=url, headers=headers, json=body, params=params, proxies=no_proxy)
        print(f"     ğŸ“¡ çŠ¶æ€: {response.status_code}")

        # ç²¾å‡†æ–­è¨€ï¼šåªçœ‹å½“å‰æ­¥éª¤
        if "âŒ" in "{{ step.description }}" or "isolated" in "{{ scenario.scenario_name }}":
             if response.status_code == 200:
                 pytest.fail(f"âŒ é¢„æœŸå¤±è´¥(é200)ï¼Œä½†å®é™…æˆåŠŸäº†")
             else:
                 print(f"     âœ… ç¬¦åˆé¢„æœŸ: æ‹’ç» (Code {response.status_code})")
        else:
             if response.status_code != 200:
                 print(f"âŒ å¤±è´¥: {response.text}")
             assert response.status_code == 200

             {% if step.extract %}
             try:
                 extracts = {{ step.extract }}
                 for var, path in extracts.items():
                     val = response.json()
                     for p in path.split('.'): val = val.get(p, {})
                     if isinstance(val, (str, int)):
                         vars_pool[var] = val
                         print(f"     âœ… æå–æˆåŠŸ: ${var} = {val}")
             except: pass
             {% endif %}
    except Exception as e:
        print(f"âŒ å¼‚å¸¸: {e}"); raise e
    {% endfor %}
    print("âœ… é€šè¿‡")
{% endfor %}